import express from "express";
import dotenv from "dotenv";
import OpenAI from "openai";

dotenv.config();

const app = express();
app.use(express.json());

const groq = new OpenAI({
  apiKey: process.env.GROQ_API_KEY,
  baseURL: "https://api.groq.com/openai/v1",
});

const chatMemory = {}; 

app.post("/rocketchat", async (req, res) => {
  const text = req.body.text;
  const user = req.body.user_name; // à¸™à¸²à¸¢ A

  if (!text) return res.sendStatus(200);

  if (!chatMemory[user]) {
    chatMemory[user] = [
      {
        role: "system",
        content: `
à¸„à¸¸à¸“à¸„à¸·à¸­ "à¸™à¸²à¸¢ B" à¹€à¸žà¸·à¹ˆà¸­à¸™à¸ªà¸™à¸´à¸—à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰

à¸à¸Žà¸à¸²à¸£à¸žà¸¹à¸” (à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸):
- à¸«à¹‰à¸²à¸¡à¸—à¸§à¸™à¸„à¸³à¸žà¸¹à¸”à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ à¹€à¸Šà¹ˆà¸™ "à¹à¸à¸šà¸­à¸à¸§à¹ˆà¸²..." à¸«à¸£à¸·à¸­ "à¸­à¹‹à¸­ à¹à¸à¸žà¸¹à¸”à¸§à¹ˆà¸²..."
- à¸«à¹‰à¸²à¸¡à¸­à¸˜à¸´à¸šà¸²à¸¢à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹€à¸žà¸´à¹ˆà¸‡à¸žà¸¹à¸”
- à¸«à¹‰à¸²à¸¡à¸žà¸¹à¸”à¸–à¸¶à¸‡ "à¸™à¸²à¸¢ A" à¸«à¸£à¸·à¸­à¸šà¸—à¸šà¸²à¸—à¸ªà¸¡à¸¡à¸•à¸´à¹ƒà¸” à¹†
- à¸«à¹‰à¸²à¸¡à¸šà¸­à¸à¸§à¹ˆà¸²à¸•à¸±à¸§à¹€à¸­à¸‡à¹€à¸›à¹‡à¸™ AI à¸«à¸£à¸·à¸­ bot
- à¸žà¸¹à¸”à¹€à¸«à¸¡à¸·à¸­à¸™à¸„à¸™à¹„à¸—à¸¢à¸„à¸¸à¸¢à¸à¸±à¸šà¹€à¸žà¸·à¹ˆà¸­à¸™à¸ˆà¸£à¸´à¸‡ à¹†
- à¹ƒà¸Šà¹‰à¸›à¸£à¸°à¹‚à¸¢à¸„à¸ªà¸±à¹‰à¸™ à¸à¸£à¸°à¸Šà¸±à¸š à¹€à¸›à¹‡à¸™à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´
- à¸–à¸²à¸¡à¸à¸¥à¸±à¸šà¹„à¸”à¹‰ à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸–à¸²à¸¡à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡
- à¸–à¹‰à¸²à¸„à¸¸à¸¢à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸‚à¹ˆà¸²à¸§ à¹ƒà¸«à¹‰à¹à¸ªà¸”à¸‡à¸„à¸§à¸²à¸¡à¹€à¸«à¹‡à¸™à¹à¸šà¸šà¹€à¸žà¸·à¹ˆà¸­à¸™ à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸™à¸±à¸à¸‚à¹ˆà¸²à¸§
- à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸£à¸¹à¹‰ à¹ƒà¸«à¹‰à¸žà¸¹à¸”à¸•à¸£à¸‡ à¹† à¹à¸šà¸šà¸„à¸™ à¹€à¸Šà¹ˆà¸™ "à¹„à¸¡à¹ˆà¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸°"

à¸ªà¹„à¸•à¸¥à¹Œà¸ à¸²à¸©à¸²:
- à¸à¸±à¸™à¹€à¸­à¸‡ à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£
- à¹ƒà¸Šà¹‰à¸„à¸³à¸§à¹ˆà¸² "à¸à¸¹ / à¸¡à¸¶à¸‡ / à¹à¸" à¹„à¸”à¹‰
- à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸ªà¸¸à¸ à¸²à¸žà¹€à¸à¸´à¸™
`
      }
    ];
  }

  // ===== à¹€à¸žà¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸‚à¸­à¸‡à¸™à¸²à¸¢ A =====
  chatMemory[user].push({
    role: "user",
    content: text
  });

  try {
    const completion = await groq.chat.completions.create({
      model: "llama-3.1-8b-instant",
      messages: chatMemory[user],
    });

    const reply = completion.choices[0].message.content;

    // ===== à¹€à¸à¹‡à¸šà¸„à¸³à¸•à¸­à¸šà¸™à¸²à¸¢ B =====
    chatMemory[user].push({
      role: "assistant",
      content: reply
    });

    res.json({ text: reply });

  } catch (err) {
    console.error("ðŸ”¥ Groq error:", err);
    res.json({ text: "âŒ à¸šà¸­à¸—à¸žà¸±à¸‡à¸§à¹ˆà¸° à¹€à¸”à¸µà¹‹à¸¢à¸§à¸¡à¸²à¹ƒà¸«à¸¡à¹ˆ" });
  }
});

app.listen(4000, () => {
  console.log("ðŸ¤– Bot listening on port 4000");
});